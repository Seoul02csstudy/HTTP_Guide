# 17장. 내용 협상과 트랜스코딩

4부는 HTTP 메시지의 엔터티 본문과 엔터티 본문이 화물처럼 싣고있는  콘텐츠에 대한 모든 것을 다룬다. 그중 17장은 어떤 콘텐츠를 받아들일 것인지 협상하는 메커니즘에 대해 설명한다.

### 1. 들어가면서
- 내 웹페이지는 한글/ 영어를 제공하며 html파일 형식으로 제공한다.
- 상황1. 영어 사용자가 요청하면 어떤 언어로 어떻게 제공해야 될까요?
- 상황2. 스페인어 사용자가 요청하면 어떤 언어로 어떻게 제공해야 될까요?
- 상황3. html을 읽을 수 없는 환경의 사용자가 요청하면 어떻게 제공해야 될까요?
- 용어
    - 배리언트(Varient): 서로 다른 리소스(버전)

### 2. 내용 협상
- 정의: 하나의 URL이 여러 가지 리소스 중 적합한것에 대응되도록 하는것
- 종류: 클라이언트 주도, 서버 주도, 투명한 협상

### 2.1 클라이언트 주도 협상
- 과정: 클라이언트가 요청 -> 서버는 선택지를 응답 -> 클라이언트가 선택 요청
- 장점: 클라이언트 입장에서 최선
- 단점: 클라이언트가 2번 요청해야되고 이에 대기시간 증가

### 2.2 서버 주도 협상
- 과정: 클라이언트 요청 -> 서버가 알아서(내용협상헤더, Vary헤더) 판단
- 장점: 클라이언트 주도보다 빠르다
- 단점: 적절한게 없다면, 서버는 추측해야 된다.

### 2.2.1 내용 협상 헤더
| 헤더       | 설명                    |
|:--------:|:---------------------:|
| Accept | 서버가 어떤 미디어 타입으로 보내도 되는지 알려준다.          |
| Accept-Language | 서버가 어떤 언어로 보내도 되는지 알려준다.         |
| Accept-Charset | 서버가 어떤 차셋으로 보내도 되는지 알려준다.         |
| Accept-Encoding | 서버가 어떤 인코딩으로 보내도 되는지 알려준다.         |

- 클라이언트가 Accept헤더를 통해서 내 선호도를 보낸다.

### 2.2.2 내용 협상 헤더의 품질값
```html
    Accept: [ text/html, application/json, image/* ... ]
    Accept-Language: fr-CH, fr;q=0.9, en;q=0.8 de;q=0.7, *;q=0.5
    Accept-Charset: utf-8, iso-8859-1;q=0.5, *;q=0.1
    Accept-Encoding: br;q=1.0, gzip;q=0.8, *;q=0.1
```

- 0.0 <= q <= 1.0
- 각 언어에 따라 선호도를 가지고 있고 각 선호도 크기에 맞춰서 탐색 및 제공

### 2.2.3 아파치의 내용 협상
- 아파치 웹 서버가 내용 협상하는 방법은 아래와 같다.
- 기본 원리: 서버가 제공할 각각의 버전들(배리언트)을 아파치 서버의 적절한 디렉터리에 보관하고 type-map 파일 사용하기, Multiviews 사용하기를 사용하여 동작한다.
- type-map 파일 사용하기: 각 배리언트에 맞게 URI를 지정해서 기록한다.
```html
    URI: index.html

    URI: index.en.html
    content-type: text/html
    content-language: en

    URI: index.fr.de.html
    content-type: text/html;charset=iso-8859-2
    content-language: fr, de
```

- Multiviews(지시어) 사용하기: 아파치가 디렉터리에 대해 자동으로 type-map을 생성하도록 한다.

### 2.3 투명 협상
- 과정: 서버대신 캐시(프락시)가 (Vary헤더를 활용하여) 서버 주도의 협상을 진행
- 장점: 서버 부하 감소
- 단점: 정형화된 명세가 없다.

### 2.3.1 캐시
- 역할: 다음에 콘텐츠를 재사용하기 위해서 임시 저장
- 상황4: 우리가 URI를 요청받아서 확인해보니 캐시 URI와 똑같아서 캐시에서 꺼내준다. 그러나, Accept헤더의 언어가 다른 경우에도 기존 캐시에서 꺼내주기 때문에 사고가 발생한다.
- 이때 다른 버전을 배리언트 혹은 얼터네이트라 한다.
- 해결방법: Accept헤더도 확인해주면 된다.

### 2.3.2 Vary 헤더
- 서버가 Vary 헤더에 추가로 확인해야할 정보(Accept헤더 등)를 캐시로 응답하면, 캐시는 이를 기준으로 새로운 요청과 캐시된 콘텐츠의 정보를 확인하여 올바른 콘텐츠를 전달한다.
```html
    Vary: User-Agent, Accept-Language
```

### 3. 트랜스 코딩
- 내용 협상의 기본 조건은 클라이언트의 요구에 맞는 문서가 존재해야 동작한다.
- 그러나 놀랍게도 맞는 문서가 없어도 기존의 다른 문서를 클라이언트의 요청에 맞는 무언가로 바꿀 수 있다. 이를 **트랜스코딩**이라 한다.
- 종류: 포맷변환, 정보 합성(내용 요약), 내용 주입(광고 삽입)
- 예시

| 전      | 후                    |
|:--------:|:---------------------:|
| HTML문서 | WML문서          |
| 고해상도 이미지 | 저해상도 이미지         |
| 광고 페이지 | 광고(x) 페이지         |